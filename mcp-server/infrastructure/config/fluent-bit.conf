# Fluent Bit configuration for MCP Draw.io Server log aggregation
# This configuration collects and forwards logs from the MCP server

[SERVICE]
    Flush         1
    Log_Level     info
    Daemon        off
    Parsers_File  parsers.conf
    HTTP_Server   On
    HTTP_Listen   0.0.0.0
    HTTP_Port     2020

# Input: Read MCP server logs
[INPUT]
    Name              tail
    Path              /var/log/mcp-server/*.log
    Path_Key          filename
    Parser            json
    Tag               mcp.server
    Refresh_Interval  5
    Mem_Buf_Limit     5MB

# Input: Read Docker container logs
[INPUT]
    Name              forward
    Listen            0.0.0.0
    Port              24224
    Tag               docker.mcp

# Filter: Add hostname and service information
[FILTER]
    Name                modify
    Match               mcp.*
    Add                 hostname ${HOSTNAME}
    Add                 service mcp-drawio-server
    Add                 environment ${ENVIRONMENT:-production}

# Filter: Parse and enrich log data
[FILTER]
    Name                parser
    Match               mcp.*
    Key_Name            log
    Parser              json
    Reserve_Data        On
    Preserve_Key        On

# Output: Forward to external log aggregation system (example: Elasticsearch)
[OUTPUT]
    Name                es
    Match               mcp.*
    Host                ${ELASTICSEARCH_HOST:-elasticsearch}
    Port                ${ELASTICSEARCH_PORT:-9200}
    Index               mcp-server-logs
    Type                _doc
    Logstash_Format     On
    Logstash_Prefix     mcp-server
    Logstash_DateFormat %Y.%m.%d
    Include_Tag_Key     On
    Tag_Key             @tag
    Time_Key            @timestamp

# Output: Forward to stdout for debugging (disable in production)
[OUTPUT]
    Name                stdout
    Match               mcp.*
    Format              json_lines