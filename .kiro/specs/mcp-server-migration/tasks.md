# 実装計画

- [x] 1. プロジェクト基盤構築とPython環境セットアップ






  - MCPサーバー用ディレクトリ構造作成（mcp-server/src/, mcp-server/tests/, mcp-server/docker/）
  - Python 3.10+仮想環境作成と必要パッケージインストール（mcp[cli], anthropic, httpx, uuid, pathlib）
  - 開発用設定ファイル作成（pyproject.toml, requirements.txt, .env.example, .gitignore）
  - _要件: 1.1, 1.2, 1.3_

- [x] 2. LLMServiceクラスのPython実装
  - Claude API統合とAnthropic SDK設定
  - システムプロンプトとユーザープロンプト構築ロジック実装（AWS図表ルール対応含む）
  - LLMError例外クラスとLLMErrorCode列挙型実装
  - _要件: 1.1, 1.4, 5.1_

- [x] 3. LLMServiceキャッシュ機能とXML処理実装
  - インメモリキャッシュ機能実装（TTL管理、サイズ制限）
  - Claude応答からXML抽出ロジック実装（コードブロック対応）
  - Draw.io XML構造検証機能実装（mxfile, mxGraphModel, root要素チェック）
  - _要件: 6.1, 1.1_

- [x] 4. FileServiceクラスのPython実装




 
  - 一時ファイル管理クラス実装（UUID ベースファイル命名、メタデータ管理）
  - .drawioファイル保存機能実装（XMLファイル書き込み、権限設定、エラーハンドリング）
  - ファイルパス解決とファイル情報取得機能実装
  - _要件: 2.1, 2.2, 2.3_

- [x] 5. FileService自動クリーンアップ機能実装





  - 期限切れファイル検出と自動削除スケジューラー実装
  - リソース管理とクリーンアップログ機能実装
  - ファイル存在チェックと期限確認機能実装
  - _要件: 7.1, 7.2, 7.3_

- [x] 6. ImageServiceクラスのPython実装





  - Draw.io CLI統合クラス実装（CLI実行ロジック、プロセス管理、タイムアウト）
  - .drawio → PNG変換機能実装と出力ファイル管理
  - CLI可用性チェック機能実装（インストール確認、バージョンチェック、キャッシュ機能）
  - _要件: 3.1, 3.2, 3.3_

- [x] 7. ImageServiceフォールバック機能実装





  - CLI利用不可時のエラーメッセージ生成とフォールバックオプション実装
  - 画像生成結果管理（成功・失敗ステータス管理、PNG ファイル保存）
  - Base64エンコード機能実装（オプション）
  - _要件: 3.3, 5.2_

- [x] 8. generate-drawio-xml MCPツール実装





  - @mcp.tool()デコレータ設定と非同期関数定義（型ヒント・ドキュメント含む）
  - 入力パラメータ定義とバリデーション実装（prompt: str、サニタイゼーション含む）
  - LLMService呼び出しとエラーハンドリング、結果フォーマット実装
  - _要件: 1.1, 1.2, 1.3, 1.4_

- [x] 9. save-drawio-file MCPツール実装





  - XMLファイル保存ツール実装（パラメータ定義: xml_content, filename）
  - FileService統合とファイルID生成・返却機能実装
  - ファイル情報返却とメタデータ管理実装（URL生成オプション含む）
  - _要件: 2.1, 2.2, 2.3_

- [x] 10. convert-to-png MCPツール実装





  - PNG変換ツール基本構造実装（パラメータ定義: file_id または file_path）
  - ImageService統合とDraw.io CLI実行機能実装
  - PNG ファイルパス返却とエラー処理・フォールバック実装
  - _要件: 3.1, 3.2, 3.3_

- [x] 11. MCPサーバーメイン実装とエラーハンドリング統合





  - MCPサーバーメインクラス実装と全ツール統合
  - 統一エラーハンドリングとログ機能実装
  - 設定管理とヘルスチェック機能実装
  - _要件: 5.1, 5.2, 5.3, 8.1_

- [x] 12. マルチステージDockerfile作成





  - ビルドステージ（Python依存関係）とランタイムステージ（実行環境のみ）設計
  - ベースイメージ選択（python:3.10-alpine）とサイズ最適化
  - Draw.io CLI インストール（npmグローバルインストール、@drawio/drawio-desktop-cli）
  - _要件: 4.1, 4.2, 4.3_

- [x] 13. コンテナ最適化とセキュリティ設定





  - イメージサイズ削減（不要パッケージ削除、キャッシュクリア、レイヤー最適化）
  - セキュリティ設定（非rootユーザー実行、最小限権限）
  - ヘルスチェック実装（サーバー起動確認、Draw.io CLI 動作確認）
  - _要件: 4.1, 4.2, 4.4_

- [x] 14. Docker Compose設定とデプロイ準備





  - 開発用設定作成（環境変数設定、ボリュームマウント）
  - 本番用設定作成（リソース制限、ログ設定）
  - 環境変数テンプレートと設定ファイル作成
  - _要件: 4.1, 4.4_

- [x] 15. LLMServiceとFileService単体テスト実装






  - LLMService テスト（XML生成テスト、エラーハンドリング確認、キャッシュ機能テスト）
  - FileService テスト（ファイル保存・取得テスト、クリーンアップ機能テスト）
  - モック戦略実装（Claude API、ファイルシステム、時間依存関数）
  - _要件: 8.1, 8.2, 8.3_

- [x] 16. ImageServiceとMCPツール統合テスト実装













  - ImageService テスト（PNG変換テスト、CLI可用性チェックテスト）
  - MCPツール統合テスト（各ツールの動作確認、ツール間連携テスト）
  - エンドツーエンドテスト（自然言語 → XML → PNG の全工程、エラーケーステスト）
  - _要件: 8.1, 8.2, 8.3, 8.4_

- [x] 17. コンテナテストとドキュメント作成





  - Dockerビルドテスト（イメージビルド確認、サイズ・依存関係チェック）
  - コンテナ実行テスト（サーバー起動確認、Draw.io CLI 動作確認、MCPツール動作確認）
  - MCPサーバー利用ガイド作成（インストール手順、設定方法、Claude Code での利用方法）
  - _要件: 8.1, 8.2, 8.3, 8.4_

- [x] 18. APIドキュメントと最終検証





  - API ドキュメント作成（各MCPツールの仕様、パラメータ・戻り値詳細、エラーコード一覧）
  - 開発者ガイド作成（開発環境セットアップ、テスト実行方法、貢献ガイドライン）
  - 最終統合テストと成功基準検証（機能完全性、パフォーマンス、軽量性、安定性確認）
  - _要件: 8.1, 8.2, 8.3, 8.4_

- [x] 19. デプロイ準備とオプション成果物





  - 本番用環境変数設定とログ設定ファイル作成
  - CI/CD設定（オプション）- テスト自動実行、Docker イメージビルド自動化
  - オプション成果物作成（Docker Hub リポジトリ、サンプルプロジェクト、パフォーマンス測定結果）
  - _要件: 4.4, 8.4_

## 📋 追加修正タスク（実装検証後の問題対応）

### 🚨 高優先度 - 重要なアーキテクチャ問題

- [x] **20. 公式MCPライブラリへの移行（クリティカル）**










  - 現在の実装がカスタムJSON-RPC実装を使用している問題を修正
  - `mcp` Python SDKのインストールと統合
  - カスタムJSON-RPCハンドリングを公式MCPサーバークラスに置き換え
  - MCP プロトコルの完全準拠を確保
  - _根拠: 長期的な互換性とプロトコル準拠のため必須_

- [x] **21. requirements.txt修正**





  - 欠落している`mcp`ライブラリの追加
  - 公式MCP SDK依存関係の追加（`mcp[cli]>=1.2.0`）
  - Python バージョン要件の明確化（3.10+）
  - _根拠: MCPサーバーの基本依存関係が欠落_

### ⚠️ 中優先度 - 機能改善

- [x] **22. MCP サーバー初期化パターンの標準化**





  - 公式MCPサーバー初期化パターンの実装
  - MCP サーバーユーティリティとヘルパーの使用
  - 標準的なMCPサーバーライフサイクル管理
  - _根拠: MCPベストプラクティスに準拠_

- [x] **23. Anthropic API キー検証の改善**





  - 起動時の実際のAPI キー検証
  - テスト用フェイクキーと本番キーの適切な区別
  - API接続の事前テスト機能
  - _根拠: 現在フェイクキーでも起動してしまう_

- [x] **24. プロトコルバージョン検証**





  - 公式MCP仕様との互換性テスト
  - プロトコルバージョン "2024-11-05" の正確性確認
  - 将来のMCP仕様更新への対応準備
  - _根拠: プロトコルバージョンの正確性が未確認_

### 🔧 低優先度 - 運用改善

- [x] **25. 依存関係チェック機能の追加**





  - Draw.io CLI の起動時可用性チェック
  - 欠落依存関係の明確なエラーメッセージ
  - セットアップ手順の自動案内機能
  - _根拠: 運用時のトラブルシューティング改善_

- [x] **26. 公式MCPクライアントとの統合テスト**





  - カスタムテストスクリプトではなく実際のMCPクライアントでのテスト
  - Claude Code での動作確認
  - その他のMCP互換クライアントでの検証
  - _根拠: 実環境での動作保証_

- [x] **27. Docker イメージ最適化**








  - MCP依存関係を含めたイメージサイズ再計算
  - セキュリティ脆弱性スキャン
  - マルチアーキテクチャ対応の確認
  - _根拠: 本番運用の品質向上_

## 📊 検証結果サマリー

### ✅ 正常に動作している機能
- MCP サーバー起動・ライフサイクル管理
- JSON-RPC プロトコル準拠（基本レベル）
- 3つのMCPツール（generate-drawio-xml, save-drawio-file, convert-to-png）
- エラーハンドリングとエッジケース対応
- ヘルスチェック機能
- テストカバレッジ（単体・統合・コンテナ）

### ⚠️ 修正が必要な問題
1. **カスタムMCP実装使用** - 公式ライブラリ未使用
2. **requirements.txt不備** - MCP依存関係欠落
3. **API キー検証不十分** - フェイクキーでも動作
4. **プロトコル準拠未確認** - 公式クライアントでの検証不足

### 🎯 推奨対応順序
1. **タスク20-21**: 公式MCPライブラリ移行（最高優先度）
2. **タスク22-24**: プロトコル標準化（高優先度）
3. **タスク25-27**: 運用品質向上（通常優先度）

これらの追加タスクを完了することで、真に本番利用可能なMCPサーバーとなります。