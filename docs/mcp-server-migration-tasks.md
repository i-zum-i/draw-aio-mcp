# AI Diagram Generator MCPサーバー化 - 実装タスクリスト

## プロジェクト概要

現行のAI図表生成Webアプリケーションのコア機能をMCP（Model Context Protocol）サーバーとして切り出し、Claude Codeで利用可能な軽量コンテナとして構築する。

## フェーズ1: 環境準備・基盤構築

### 1.1 プロジェクト構造準備
- [ ] **1.1.1** MCPサーバー用ディレクトリ構造作成
  - `mcp-server/` ルートディレクトリ作成
  - `mcp-server/src/` ソースコードディレクトリ
  - `mcp-server/tests/` テストディレクトリ
  - `mcp-server/docker/` Dockerファイル関連

### 1.2 開発環境構築
- [ ] **1.2.1** Python環境セットアップ
  - Python 3.10+ 環境構築
  - 仮想環境作成・設定
- [ ] **1.2.2** 必要なパッケージインストール
  - `mcp[cli]` SDK
  - `httpx` HTTP客户端
  - `anthropic` Claude API SDK
  - `uuid`, `pathlib` など基本ライブラリ
- [ ] **1.2.3** 開発用設定ファイル作成
  - `pyproject.toml` / `requirements.txt`
  - `.env.example` 環境変数テンプレート
  - `.gitignore` 設定

## フェーズ2: コアサービス移植

### 2.1 LLMService移植
- [ ] **2.1.1** Claude API統合クラス作成
  - `LLMService` クラスをPythonで実装
  - Anthropic SDK統合
  - API認証・設定管理
- [ ] **2.1.2** Draw.io XMLプロンプト移植
  - システムプロンプト定義
  - ユーザープロンプト構築ロジック
  - AWS図表ルール対応
- [ ] **2.1.3** エラーハンドリング実装
  - `LLMError` 例外クラス
  - `LLMErrorCode` 列挙型
  - Anthropic API エラー分類
- [ ] **2.1.4** キャッシュ機能実装
  - インメモリキャッシュ
  - TTL管理
  - キャッシュサイズ制限

### 2.2 XMLバリデーション実装
- [ ] **2.2.1** Draw.io XML構造検証
  - 必須要素チェック（mxfile, mxGraphModel, root）
  - 基本的なXML構文検証
- [ ] **2.2.2** XML抽出ロジック
  - Claude応答からXML抽出
  - コードブロック対応
  - 形式エラーハンドリング

## フェーズ3: ファイル管理システム

### 3.1 FileService移植
- [ ] **3.1.1** 一時ファイル管理クラス作成
  - `FileService` クラス実装
  - UUID ベースファイル命名
  - ファイルメタデータ管理
- [ ] **3.1.2** .drawioファイル保存機能
  - XMLファイル書き込み
  - ファイル権限設定
  - エラーハンドリング
- [ ] **3.1.3** 一時ファイルクリーンアップ
  - 期限切れファイル検出
  - 自動削除スケジューラー
  - リソース管理

### 3.2 ファイルアクセス機能
- [ ] **3.2.1** ファイルパス解決
  - ファイルID → パス変換
  - 存在チェック・期限確認
- [ ] **3.2.2** ファイル情報取得
  - ファイルメタデータ返却
  - サイズ・作成日時情報

## フェーズ4: 画像生成システム

### 4.1 ImageService移植
- [ ] **4.1.1** Draw.io CLI統合クラス作成
  - `ImageService` クラス実装
  - CLI実行ロジック
  - プロセス管理・タイムアウト
- [ ] **4.1.2** PNG変換機能
  - .drawio → PNG変換
  - 出力ファイル管理
  - 一時ファイルクリーンアップ
- [ ] **4.1.3** CLI可用性チェック
  - Draw.io CLI インストール確認
  - バージョンチェック
  - キャッシュ機能付き検証

### 4.2 フォールバック機能
- [ ] **4.2.1** CLI利用不可時の処理
  - エラーメッセージ生成
  - フォールバックオプション検討
- [ ] **4.2.2** 画像生成結果管理
  - 成功・失敗ステータス管理
  - PNG ファイル保存

## フェーズ5: MCPツール実装

### 5.1 generate-drawio-xml ツール
- [ ] **5.1.1** MCPツール基本実装
  - `@mcp.tool()` デコレータ設定
  - 非同期関数定義
  - 型ヒント・ドキュメント
- [ ] **5.1.2** 入力パラメータ定義
  - `prompt: str` パラメータ
  - バリデーション実装
  - サニタイゼーション
- [ ] **5.1.3** XML生成処理
  - LLMService 呼び出し
  - エラーハンドリング
  - 結果フォーマット

### 5.2 save-drawio-file ツール
- [ ] **5.2.1** MCPツール実装
  - XMLファイル保存ツール
  - パラメータ定義（xml_content, filename）
- [ ] **5.2.2** ファイル保存処理
  - FileService 統合
  - ファイルID生成・返却
- [ ] **5.2.3** メタデータ管理
  - ファイル情報返却
  - URL生成（オプション）

### 5.3 convert-to-png ツール
- [ ] **5.3.1** MCPツール実装
  - PNG変換ツール基本構造
  - パラメータ定義（file_id または file_path）
- [ ] **5.3.2** 変換処理実装
  - ImageService 統合
  - Draw.io CLI 実行
- [ ] **5.3.3** 結果処理
  - PNG ファイルパス返却
  - Base64エンコード（オプション）
  - エラー処理・フォールバック

## フェーズ6: コンテナ化

### 6.1 Dockerfile作成
- [ ] **6.1.1** マルチステージビルド設計
  - ビルドステージ: Python依存関係
  - ランタイムステージ: 実行環境のみ
- [ ] **6.1.2** ベースイメージ選択
  - `node:18-alpine` または `python:3.10-alpine`
  - サイズ最適化考慮
- [ ] **6.1.3** Draw.io CLI インストール
  - npmによるグローバルインストール
  - `@drawio/drawio-desktop-cli` パッケージ
  - 依存関係最小化

### 6.2 コンテナ最適化
- [ ] **6.2.1** イメージサイズ削減
  - 不要なパッケージ削除
  - キャッシュクリア
  - レイヤー最適化
- [ ] **6.2.2** セキュリティ設定
  - 非rootユーザー実行
  - 必要最小限の権限
- [ ] **6.2.3** ヘルスチェック実装
  - サーバー起動確認
  - Draw.io CLI 動作確認

### 6.3 Docker Compose設定
- [ ] **6.3.1** 開発用設定作成
  - 環境変数設定
  - ボリュームマウント
- [ ] **6.3.2** 本番用設定作成
  - リソース制限
  - ロギング設定

## フェーズ7: テスト・検証

### 7.1 単体テスト
- [ ] **7.1.1** LLMService テスト
  - XML生成テスト
  - エラーハンドリング確認
  - キャッシュ機能テスト
- [ ] **7.1.2** FileService テスト
  - ファイル保存・取得テスト
  - クリーンアップ機能テスト
- [ ] **7.1.3** ImageService テスト
  - PNG変換テスト
  - CLI可用性チェックテスト

### 7.2 統合テスト
- [ ] **7.2.1** MCPツール統合テスト
  - 各ツールの動作確認
  - ツール間連携テスト
- [ ] **7.2.2** エンドツーエンドテスト
  - 自然言語 → XML → PNG の全工程
  - エラーケーステスト

### 7.3 コンテナテスト
- [ ] **7.3.1** Dockerビルドテスト
  - イメージビルド確認
  - サイズ・依存関係チェック
- [ ] **7.3.2** コンテナ実行テスト
  - サーバー起動確認
  - Draw.io CLI 動作確認
  - MCPツール動作確認

## フェーズ8: ドキュメント・デプロイ

### 8.1 ドキュメント作成
- [ ] **8.1.1** MCPサーバー利用ガイド
  - インストール手順
  - 設定方法
  - Claude Code での利用方法
- [ ] **8.1.2** API ドキュメント
  - 各MCPツールの仕様
  - パラメータ・戻り値詳細
  - エラーコード一覧
- [ ] **8.1.3** 開発者ガイド
  - 開発環境セットアップ
  - テスト実行方法
  - 貢献ガイドライン

### 8.2 デプロイ準備
- [ ] **8.2.1** 設定ファイル作成
  - 本番用環境変数設定
  - ログ設定
- [ ] **8.2.2** CI/CD設定（オプション）
  - テスト自動実行
  - Docker イメージビルド自動化

## 成果物チェックリスト

### 必須成果物
- [ ] **MCPサーバー実行可能ファイル** (`mcp-server/src/server.py`)
- [ ] **Dockerイメージ** (軽量コンテナ)
- [ ] **利用ドキュメント** (Claude Code での利用方法)
- [ ] **テストスイート** (単体・統合テスト)

### オプション成果物
- [ ] **Docker Hub リポジトリ** (パブリックイメージ)
- [ ] **サンプルプロジェクト** (利用例)
- [ ] **パフォーマンス測定結果** (現行システムとの比較)

## 推定工数

- **フェーズ1-2**: 3-4日 (環境準備・コアサービス移植)
- **フェーズ3-4**: 2-3日 (ファイル・画像生成システム)
- **フェーズ5**: 2-3日 (MCPツール実装)
- **フェーズ6**: 2-3日 (コンテナ化)
- **フェーズ7**: 2-3日 (テスト・検証)
- **フェーズ8**: 1-2日 (ドキュメント・デプロイ)

**合計推定工数**: 12-18日

## 成功基準

1. **機能完全性**: 現行システムの全機能をMCPサーバーで再現
2. **パフォーマンス**: 現行システム同等以上の応答速度
3. **軽量性**: Dockerイメージサイズ < 500MB
4. **安定性**: 24時間連続稼働での異常終了なし
5. **利便性**: Claude Code での簡単な設定・利用が可能